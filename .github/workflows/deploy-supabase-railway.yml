# Deploy automático Supabase (migrações) e Railway (backend)
# Altere variáveis conforme necessário

name: Deploy Supabase e Railway

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  supabase-migrations:
    name: Aplicar migrações Supabase
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./supabase
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Instalar Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Aplicar migrações no Supabase
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          supabase link --project-ref $SUPABASE_PROJECT_ID
          supabase db push || echo "Migration may have partial failure, check logs"

  railway-deploy:
    name: Deploy backend Railway
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Instalar Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy para Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway up --service 20260105-wgeasy --detach
